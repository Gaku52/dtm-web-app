# 機能詳細設計書

**作成日**: 2025-11-06
**バージョン**: 1.0.0

---

## 目次

1. [UI/UXデザイン](#1-uiuxデザイン)
2. [エディタ画面の詳細設計](#2-エディタ画面の詳細設計)
3. [ピアノロール機能](#3-ピアノロール機能)
4. [波形表示機能](#4-波形表示機能)
5. [トランスポートコントロール](#5-トランスポートコントロール)
6. [トラック管理](#6-トラック管理)
7. [プロジェクト管理](#7-プロジェクト管理)
8. [キーボードショートカット](#8-キーボードショートカット)

---

## 1. UI/UXデザイン

### 1.1 デザインコンセプト

**「Linear + Figma + Ableton Liveの融合」**

- **Linear**: クリーンで洗練されたUI
- **Figma**: 直感的な操作性
- **Ableton Live**: プロフェッショナルなDAWの機能性

### 1.2 カラーシステム

```typescript
// tailwind.config.js
module.exports = {
  theme: {
    extend: {
      colors: {
        // Primary
        primary: {
          50: '#EEF2FF',
          100: '#E0E7FF',
          500: '#6366F1',  // メインカラー
          600: '#4F46E5',
          700: '#4338CA',
        },

        // Background
        background: {
          primary: '#0F1117',    // 最も暗い背景
          secondary: '#1A1D29',  // パネル背景
          tertiary: '#252834',   // ホバー時
        },

        // Surface
        surface: {
          primary: '#1E2330',
          secondary: '#2A2F3F',
          hover: '#343A4F',
        },

        // Text
        text: {
          primary: '#FFFFFF',
          secondary: '#A0AEC0',
          tertiary: '#718096',
        },

        // Accent
        accent: {
          note: '#60A5FA',      // ノートの色
          playhead: '#EF4444',  // 再生ヘッド
          grid: '#374151',      // グリッド線
          selection: '#8B5CF6', // 選択範囲
        }
      }
    }
  }
}
```

### 1.3 タイポグラフィ

```css
/* globals.css */
:root {
  --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: 'JetBrains Mono', 'Fira Code', monospace;
}

/* 見出し */
h1 { font-size: 32px; font-weight: 700; letter-spacing: -0.02em; }
h2 { font-size: 24px; font-weight: 600; letter-spacing: -0.01em; }
h3 { font-size: 18px; font-weight: 600; }

/* 本文 */
body { font-size: 14px; line-height: 1.5; }

/* キャプション */
.caption { font-size: 12px; color: var(--text-tertiary); }
```

---

## 2. エディタ画面の詳細設計

### 2.1 レイアウト構成

```
┌────────────────────────────────────────────────────────────┐
│  Header (64px)                                             │
│  ┌──────┐ [Project Name]     [Save] [Export] [@username] │
│  │ Logo │                                                  │
│  └──────┘                                                  │
├────────────────────────────────────────────────────────────┤
│  Toolbar (48px)                                            │
│  [◀◀] [▶] [■]  120 BPM  4/4  [Loop] [Metronome] [Undo]   │
├─────────┬──────────────────────────────────────────────────┤
│         │                                                  │
│ Track   │          Piano Roll Canvas                      │
│ List    │          (Main Editor Area)                     │
│ (200px) │                                                  │
│         │                                                  │
│ 🎹 Piano│          [Notes displayed here]                 │
│ 🎸 Guitar│                                                 │
│ 🥁 Drums│                                                  │
│ + Track │                                                  │
│         │                                                  │
├─────────┴──────────────────────────────────────────────────┤
│  Timeline & Waveform (120px)                              │
│  ▂▃▅▇█▇▅▃▂ ▂▃▅▇█▇▅▃▂ ▂▃▅▇█▇▅▃▂                          │
│  |-----|-----|-----|-----|-----|                          │
│  0     4     8    12    16    20  (bars)                  │
└────────────────────────────────────────────────────────────┘
```

### 2.2 レスポンシブ対応

#### デスクトップ（> 1024px）
- 上記レイアウト

#### タブレット（640px - 1024px）
```
┌──────────────────────────┐
│  Header                  │
├──────────────────────────┤
│  Toolbar                 │
├──────────────────────────┤
│                          │
│  Piano Roll              │
│  (Track選択メニュー)     │
│                          │
├──────────────────────────┤
│  Timeline                │
└──────────────────────────┘
```

#### モバイル（< 640px）
```
┌──────────────┐
│  Header      │
├──────────────┤
│  ▶ 120 BPM   │
├──────────────┤
│              │
│  Piano Roll  │
│  (簡易版)    │
│              │
└──────────────┘
```

---

## 3. ピアノロール機能

### 3.1 基本操作

#### ノートの配置
- **クリック**: ノート配置（デフォルト: 1拍の長さ）
- **ドラッグ**: ノートの長さを調整しながら配置
- **ダブルクリック**: ノート削除

#### ノートの編集
- **ドラッグ**: ノートを移動
- **右端をドラッグ**: ノートの長さを変更
- **Shift + クリック**: 複数選択
- **Cmd/Ctrl + ドラッグ**: 範囲選択
- **Cmd/Ctrl + C/V**: コピー＆ペースト
- **Cmd/Ctrl + D**: 複製
- **Delete/Backspace**: 削除

#### ベロシティ編集
- **Alt + ドラッグ（上下）**: ベロシティ調整
- ノートの色の濃さでベロシティを表現

### 3.2 グリッド設定

```typescript
type GridResolution =
  | '1/1'   // 全音符
  | '1/2'   // 2分音符
  | '1/4'   // 4分音符
  | '1/8'   // 8分音符
  | '1/16'  // 16分音符
  | '1/32'  // 32分音符
  | '1/64'; // 64分音符

interface GridSettings {
  resolution: GridResolution;
  snap: boolean;          // スナップの有効/無効
  triplet: boolean;       // 3連符モード
}
```

**UI表示:**
```
Toolbar: [Grid: 1/16 ▼] [⊞ Snap: ON] [♪ Triplet: OFF]
```

### 3.3 ズーム・スクロール

#### 水平ズーム（時間軸）
- **Cmd/Ctrl + スクロール**: ズームイン/アウト
- **ピンチジェスチャー**: タッチデバイス対応
- **ズームスライダー**: UI右下

```
[−] ━━●━━━━━━━━━ [+]
    10%         200%
```

#### 垂直ズーム（音程軸）
- **Shift + スクロール**: ズームイン/アウト
- 音域: C0 - C8（88鍵）

#### スクロール
- **スクロールホイール**: 垂直スクロール
- **Shift + スクロール**: 水平スクロール
- **スペースキー + ドラッグ**: ハンドツール

### 3.4 視覚的フィードバック

#### ノートの色分け
```typescript
interface NoteColor {
  default: string;      // #60A5FA（青）
  selected: string;     // #8B5CF6（紫）
  muted: string;        // #6B7280（グレー）
  recording: string;    // #EF4444（赤）
}
```

#### ベロシティの可視化
- **透明度**: velocity / 127
- **色の濃さ**: 薄い = 弱い、濃い = 強い

#### ホバー効果
- ノートにホバー: ボーダー表示（2px, white）
- グリッドセルにホバー: 背景色変更（#343A4F）

---

## 4. 波形表示機能

### 4.1 リアルタイム波形生成

```typescript
interface WaveformSettings {
  height: number;        // 120px
  barWidth: number;      // 2px
  barGap: number;        // 1px
  color: string;         // '#4F46E5'
  progressColor: string; // '#818CF8'
}
```

### 4.2 波形の種類

#### オプション1: 簡易波形（推奨・MVP）
- トラックごとにノートの密度を可視化
- 計算コストが低い
- リアルタイム更新が容易

```typescript
function generateSimpleWaveform(notes: Note[], duration: number): number[] {
  const samples = 1000; // 1000サンプル
  const waveform = new Array(samples).fill(0);

  notes.forEach(note => {
    const index = Math.floor((note.start_time / duration) * samples);
    waveform[index] += note.velocity / 127;
  });

  return waveform;
}
```

#### オプション2: リアル波形（v2以降）
- 実際の音声データから生成
- Web Audio APIのAnalyserNodeを使用
- 計算コストが高い

### 4.3 UI表示

```
┌─────────────────────────────────────────────┐
│ Track 1: Piano                              │
│ ▂▃▅▇█▇▅▃▂ ▂▃▅▇█▇▅▃▂ ▂▃▅▇█▇▅▃▂             │
├─────────────────────────────────────────────┤
│ Track 2: Guitar                             │
│ ▁▂▃▄▅▆▇█ ▁▂▃▄▅▆▇█ ▁▂▃▄▅▆▇█                 │
└─────────────────────────────────────────────┘
```

---

## 5. トランスポートコントロール

### 5.1 再生コントロール

```
┌─────────────────────────────────────────┐
│ [◀◀] [▶/❚❚] [■] [●]                   │
│  Skip  Play  Stop Record               │
│  Back  Pause                            │
└─────────────────────────────────────────┘
```

#### ボタン詳細

| ボタン | 機能 | ショートカット |
|--------|------|----------------|
| ◀◀ | 先頭に戻る | Home |
| ▶ | 再生 | Space |
| ❚❚ | 一時停止 | Space |
| ■ | 停止（先頭に戻る） | Esc |
| ● | 録音（v2以降） | - |

### 5.2 BPM調整

```
┌──────────────────┐
│  [−] 120 [+]     │
│      BPM         │
└──────────────────┘
```

- **範囲**: 40 - 300 BPM
- **デフォルト**: 120 BPM
- **ステップ**: 1 BPM
- **ダブルクリック**: 直接入力モード

**使用例:**
```typescript
const [tempo, setTempo] = useState(120);

function adjustTempo(delta: number) {
  setTempo(prev => Math.max(40, Math.min(300, prev + delta)));
}
```

### 5.3 拍子設定

```
┌──────────────┐
│   4 / 4 ▼    │
└──────────────┘
```

**選択肢:**
- 4/4（最も一般的）
- 3/4（ワルツ）
- 6/8（シャッフル）
- 5/4（変拍子）
- 7/8（プログレッシブ）
- カスタム

### 5.4 ループ機能

```
┌─────────────────────────────┐
│ [🔁 Loop: OFF]              │
│                             │
│ Start: 0:00  End: 1:00      │
└─────────────────────────────┘
```

**操作:**
- ループ範囲を選択（Cmd + ドラッグ）
- ループ開始/終了点を個別に設定
- ループON/OFFをトグル

### 5.5 メトロノーム

```
┌──────────────────┐
│ [🎵] Metronome   │
│      OFF         │
└──────────────────┘
```

**設定:**
- Volume: 0-100%
- 拍のアクセント: 強拍/弱拍

### 5.6 タイムライン表示

```
|───|───|───|───|───|───|───|───|
0   4   8   12  16  20  24  28  (bars)
0:00    0:08    0:16    0:24    (time)
```

**表示モード:**
- 小節番号（Bars & Beats）
- 時間（Minutes:Seconds）
- サンプル数（Samples）- v2以降

---

## 6. トラック管理

### 6.1 トラックリスト

```
┌─────────────────────────────────┐
│ Track 1  🎹 Piano       [Solo]  │
│ ●●●●●●●●━━━━━━━━━━━━━━━ 80%    │
│ [M] [S] [R]                     │
├─────────────────────────────────┤
│ Track 2  🎸 Guitar      [Solo]  │
│ ●●●●●●━━━━━━━━━━━━━━━━━ 60%    │
│ [M] [S] [R]                     │
├─────────────────────────────────┤
│ Track 3  🥁 Drums       [Solo]  │
│ ●●●●●●●●●●━━━━━━━━━━━━━ 100%   │
│ [M] [S] [R]                     │
├─────────────────────────────────┤
│ + Add Track                     │
└─────────────────────────────────┘

M = Mute
S = Solo
R = Record (v2)
```

### 6.2 トラックの追加

**フロー:**
```
[+ Add Track] をクリック
    ↓
┌─────────────────────────┐
│ Select Instrument       │
│ ┌─────┐ ┌─────┐        │
│ │ 🎹  │ │ 🎸  │        │
│ │Piano│ │Guitar│       │
│ └─────┘ └─────┘        │
│ ┌─────┐ ┌─────┐        │
│ │ 🥁  │ │ 🎻  │        │
│ │Drums│ │Violin│       │
│ └─────┘ └─────┘        │
│                         │
│ [Cancel] [Add]          │
└─────────────────────────┘
```

### 6.3 トラック設定

**クリックして展開:**
```
┌──────────────────────────────────┐
│ Track 1  🎹 Piano                │
│                                  │
│ Name: [Piano Lead________]       │
│                                  │
│ Instrument: [Piano ▼]            │
│                                  │
│ Volume:  [−] ●●●●●●━━━━ [+] 80% │
│                                  │
│ Pan:     [L] ━━━●━━━━━━ [R] C   │
│                                  │
│ Color:   🔵 🟢 🟡 🔴 🟣         │
│                                  │
│ [Delete Track]                   │
└──────────────────────────────────┘
```

### 6.4 トラックの並び替え

- **ドラッグ＆ドロップ**: トラックをドラッグして順序変更
- **視覚的フィードバック**: ドラッグ中は半透明表示

---

## 7. プロジェクト管理

### 7.1 ダッシュボード

```
┌─────────────────────────────────────────────┐
│ My Projects                    [+ New]      │
├─────────────────────────────────────────────┤
│ ┌───────────┐ ┌───────────┐ ┌───────────┐ │
│ │ Project 1 │ │ Project 2 │ │ Project 3 │ │
│ │ ▂▃▅▇█▇▅▃▂ │ │ ▂▃▅▇█▇▅▃▂ │ │ ▂▃▅▇█▇▅▃▂ │ │
│ │ 120 BPM   │ │ 140 BPM   │ │ 90 BPM    │ │
│ │ 4 tracks  │ │ 6 tracks  │ │ 3 tracks  │ │
│ │ 2:34      │ │ 3:45      │ │ 1:23      │ │
│ │ 2 days ago│ │ 1 week ago│ │ 2 hrs ago │ │
│ └───────────┘ └───────────┘ └───────────┘ │
└─────────────────────────────────────────────┘
```

### 7.2 プロジェクト作成

```
┌────────────────────────────────┐
│ Create New Project             │
│                                │
│ Name: [My Song_______]         │
│                                │
│ Template:                      │
│ ◉ Blank                        │
│ ○ Pop Song (4 tracks)          │
│ ○ Electronic (8 tracks)        │
│ ○ Acoustic (3 tracks)          │
│                                │
│ BPM: [120]  Time: [4/4 ▼]     │
│                                │
│ [Cancel]  [Create]             │
└────────────────────────────────┘
```

### 7.3 自動保存

```
┌──────────────────────────┐
│ 💾 Auto-saved 2 min ago  │
└──────────────────────────┘
```

**仕様:**
- 30秒ごとに自動保存
- 変更がない場合は保存しない
- 保存中はインジケーター表示
- 保存履歴は最新10件

### 7.4 エクスポート（v2以降）

```
┌──────────────────────────────┐
│ Export Project               │
│                              │
│ Format:                      │
│ ◉ MIDI (.mid)                │
│ ○ Audio (.wav)               │
│ ○ Audio (.mp3)               │
│                              │
│ Quality: [High ▼]            │
│                              │
│ [Cancel]  [Export]           │
└──────────────────────────────┘
```

---

## 8. キーボードショートカット

### 8.1 基本操作

| ショートカット | 機能 |
|---------------|------|
| **Space** | 再生/一時停止 |
| **Esc** | 停止 |
| **Home** | 先頭に戻る |
| **Cmd/Ctrl + S** | 保存 |
| **Cmd/Ctrl + Z** | 元に戻す |
| **Cmd/Ctrl + Shift + Z** | やり直し |
| **Cmd/Ctrl + C** | コピー |
| **Cmd/Ctrl + V** | ペースト |
| **Cmd/Ctrl + X** | カット |
| **Cmd/Ctrl + D** | 複製 |
| **Cmd/Ctrl + A** | すべて選択 |
| **Delete/Backspace** | 削除 |

### 8.2 表示操作

| ショートカット | 機能 |
|---------------|------|
| **Cmd/Ctrl + スクロール** | 水平ズーム |
| **Shift + スクロール** | 垂直ズーム |
| **Cmd/Ctrl + 0** | ズームリセット |
| **Cmd/Ctrl + +** | ズームイン |
| **Cmd/Ctrl + -** | ズームアウト |
| **Space + ドラッグ** | ハンドツール |

### 8.3 編集操作

| ショートカット | 機能 |
|---------------|------|
| **Shift + クリック** | 複数選択 |
| **Cmd/Ctrl + ドラッグ** | 範囲選択 |
| **Alt + ドラッグ** | ベロシティ調整 |
| **Cmd/Ctrl + L** | ループ範囲設定 |
| **M** | 選択トラックをミュート |
| **S** | 選択トラックをソロ |

### 8.4 トラック操作

| ショートカット | 機能 |
|---------------|------|
| **Cmd/Ctrl + T** | 新規トラック追加 |
| **Cmd/Ctrl + Shift + D** | トラック複製 |
| **Cmd/Ctrl + Shift + Delete** | トラック削除 |
| **↑/↓** | トラック選択を移動 |

---

## 9. パフォーマンス要件（再掲）

| 機能 | 目標 |
|------|------|
| ノート配置レスポンス | < 50ms |
| 描画フレームレート | 60 FPS |
| 10,000ノートでの動作 | スムーズ |
| 5分楽曲の再生 | 安定 |
| 自動保存 | 30秒ごと |

---

## 10. アクセシビリティ

### 10.1 キーボード操作

- すべての機能がキーボードで操作可能
- Tabキーでフォーカス移動
- フォーカスインジケーターを明確に表示

### 10.2 スクリーンリーダー対応

- aria-label属性を適切に設定
- ボタンの状態（pressed, expanded）を明示

### 10.3 色覚サポート

- 色だけに依存しない情報伝達
- パターンやアイコンで補完

---

## 11. エラーハンドリング

### 11.1 音源読み込み失敗

```
┌────────────────────────────────┐
│ ⚠️  Failed to load instrument  │
│                                │
│ Piano samples could not be     │
│ loaded. Check your connection. │
│                                │
│ [Retry] [Use Fallback]         │
└────────────────────────────────┘
```

### 11.2 保存失敗

```
┌────────────────────────────────┐
│ ❌ Failed to save project      │
│                                │
│ Your changes could not be      │
│ saved. Retrying automatically. │
│                                │
│ [Retry Now] [Save Locally]     │
└────────────────────────────────┘
```

### 11.3 ブラウザ非対応

```
┌────────────────────────────────┐
│ ⚠️  Browser Not Supported      │
│                                │
│ This app requires Web Audio    │
│ API support. Please use:       │
│ • Chrome 90+                   │
│ • Firefox 88+                  │
│ • Safari 14+                   │
│                                │
│ [Learn More]                   │
└────────────────────────────────┘
```

---

## 12. 次のステップ

明日実施:
1. Supabase Pro契約
2. Vercelデプロイ設定
3. UI実装開始（shadcn/ui導入）
4. ピアノロールの基本実装
5. 音声エンジンの基礎実装

---

**これらの設計に基づいて、素晴らしいDTMアプリケーションを構築します！**
