# DTM Web App - 音声機能テストガイド

## 🎵 修正内容まとめ

### 問題点と解決策

#### 1. Tone.jsの初期化問題
**問題**: `Tone.start()`が呼ばれていないため、Web Audio Contextが起動しない
**解決**: `playNote`関数内で`await Tone.start()`を呼び出すように修正

#### 2. 非同期処理の未対応
**問題**: `playNote`関数が非同期処理に対応していない
**解決**: `async/await`を使って適切に処理

#### 3. デバッグログの不足
**問題**: エラーが発生しても原因が特定できない
**解決**: 詳細なコンソールログを追加（🎵, ✅, ❌ の絵文字付き）

### 修正したファイル

1. **src/hooks/useAudioEngine.ts**
   - `playNote`を`async`関数に変更
   - `Tone.start()`の呼び出しを追加
   - 詳細なログ出力を追加

2. **src/components/editor/PianoRoll.tsx**
   - `onPlayNote`の型を`Promise<void>`に変更
   - `await onPlayNote()`で呼び出すように修正
   - ログ出力を追加

3. **src/app/test-audio/page.tsx** (新規作成)
   - Tone.jsの動作確認用ページ
   - 音名、MIDIノート、和音、音量テストが可能

---

## 🧪 テスト方法

### 方法1: 簡単なテスト（推奨）

開発サーバーを起動して、テストページにアクセス：

```bash
npm run dev
```

ブラウザで以下のURLを開く：
```
http://localhost:3000/test-audio
```

**テスト手順:**
1. ページが読み込まれたら、「Tone.js 初期化完了」の緑ランプを確認
2. 「1. 音名で再生」セクションの「C4」ボタンをクリック
3. **音が鳴ることを確認** 🎵
4. 他のボタン（D4, E4など）をクリックして、異なる音程が出ることを確認
5. 「4. 音量テスト」で音量が変わることを確認

**期待される動作:**
- ボタンをクリックすると即座に音が鳴る
- ブラウザのコンソールに以下のようなログが表示される：
  ```
  🎵 Tone.js context started
  🎵 Playing note: C4
  ✅ Note played successfully
  ```

**もし音が鳴らない場合:**
1. ブラウザの音量がオンになっているか確認
2. ヘッドフォン/スピーカーが接続されているか確認
3. ブラウザのコンソール（F12 → Console）でエラーメッセージを確認
4. ❌マークのエラーログがあれば、その内容を確認

---

### 方法2: エディタでテスト（フル機能）

#### 前提条件
- 開発サーバーが起動している (`npm run dev`)
- テストユーザーでログイン可能 (`gan.hmhm333@gmail.com` / `password123`)

#### テスト手順

##### ステップ1: ログイン
1. `http://localhost:3000/auth/login` を開く
2. メールアドレス: `gan.hmhm333@gmail.com`
3. パスワード: `password123`
4. 「ログイン」をクリック
5. ✅ ダッシュボードにリダイレクトされることを確認

##### ステップ2: プロジェクト作成
1. 「新規プロジェクト」ボタンをクリック
2. ✅ エディタページ (`/editor/[id]`) に移動することを確認
3. ✅ ブラウザコンソールに以下のログが表示されることを確認：
   ```
   🎵 Initializing Audio Engine...
   ✅ Audio Engine initialized successfully
   ```

##### ステップ3: トラック追加
1. 左サイドバーの「トラックを追加」ボタンをクリック
2. ✅ 「トラック 1」が表示されることを確認
3. ✅ トラックが選択状態（背景がグレー）になることを確認

##### ステップ4: ノート配置（🔴 最重要テスト）
1. ピアノロール（右側のキャンバスエリア）をクリック
2. **✅ 音が鳴ることを確認** 🎵
3. ✅ クリックした位置に青い矩形（ノート）が表示されることを確認
4. ✅ ブラウザコンソールに以下のログが表示されることを確認：
   ```
   🎹 Piano Roll: Playing note {pitch: 60, velocity: 100}
   🎵 Tone.js context started
   🎵 Playing note: MIDI 60 (261.63Hz), duration: 0.5s, velocity: 100
   ✅ Note played successfully
   ```

##### ステップ5: 複数ノート配置（音程テスト）
1. ピアノロールの異なる位置（高さ）を複数クリック
2. **✅ 各クリックで異なる音程の音が鳴ることを確認** 🎵
3. ✅ 低い位置（キャンバスの下側） = 高い音
4. ✅ 高い位置（キャンバスの上側） = 低い音

##### ステップ6: Mute機能テスト
1. トラックリストの「M」ボタンをクリック
2. ✅ 「M」ボタンが赤色になることを確認
3. ピアノロールをクリック
4. **✅ 音が鳴らない または ログだけ表示されることを確認** 🔇
5. 再度「M」ボタンをクリック
6. ✅ 「M」ボタンがグレーに戻ることを確認
7. ピアノロールをクリック
8. **✅ 再び音が鳴ることを確認** 🎵

---

## ✅ 成功の基準

以下がすべて確認できれば、音声機能は正常に動作しています：

### 必須確認項目
- [x] `/test-audio`で C4 ボタンをクリックして音が鳴る
- [x] `/test-audio`で異なる音程のボタンで異なる音が鳴る
- [x] `/test-audio`で音量テストで音量が変わる
- [x] エディタでピアノロールをクリックして音が鳴る
- [x] エディタで異なる位置をクリックすると異なる音程が鳴る
- [x] ブラウザコンソールに 🎵 と ✅ のログが表示される
- [x] エラーログ（❌）が表示されない

---

## 🐛 トラブルシューティング

### 音が全く鳴らない場合

#### チェック1: ブラウザの音量設定
- システム音量がミュートになっていないか
- ブラウザのタブがミュートになっていないか
- ヘッドフォン/スピーカーが正しく接続されているか

#### チェック2: ブラウザのコンソールログ
F12キーを押して開発者ツールを開き、Consoleタブを確認：

**正常なログ例:**
```
🎵 Initializing Audio Engine...
✅ Audio Engine initialized successfully
Synth: PolySynth {...}
Tempo: 120 BPM
🎵 Tone.js context started
🎵 Playing note: MIDI 60 (261.63Hz), duration: 0.5s, velocity: 100
✅ Note played successfully
```

**エラーログ例:**
```
❌ Synth not initialized
❌ Failed to initialize Audio Engine: Error: ...
❌ Error playing note: Error: ...
```

#### チェック3: Tone.jsの初期化確認
1. `/test-audio`ページを開く
2. 「Tone.js 初期化完了」の緑ランプが表示されるか確認
3. デバッグ情報の「Synth Ready」が「Yes」になっているか確認

### 音が小さすぎる場合
- システムの音量を上げる
- ブラウザの音量設定を確認
- `/test-audio`の「音量テスト」で音量 100% ボタンをクリック

### 特定の音程だけ鳴らない場合
- ブラウザコンソールでエラーを確認
- MIDI番号が 0-127 の範囲内か確認

---

## 📝 報告用テンプレート

テスト結果を報告する際は、以下の情報を含めてください：

```
【テスト環境】
- OS: (例: macOS 14.2)
- ブラウザ: (例: Chrome 120)
- Node.js: (npm run devで確認可能)

【テスト結果】
/test-audio ページ:
- [ ] C4ボタンで音が鳴った / 鳴らなかった
- [ ] 異なる音程が確認できた / できなかった
- [ ] 音量が変わることを確認できた / できなかった

エディタページ:
- [ ] トラック追加できた / できなかった
- [ ] ピアノロールクリックで音が鳴った / 鳴らなかった
- [ ] 異なる位置で異なる音程が確認できた / できなかった

【コンソールログ】
(ブラウザコンソールのログをコピー&ペースト)

【その他気づいた点】
(あれば記入)
```

---

## 🎯 次のステップ

音が正常に鳴ることが確認できたら：

1. コードをコミット&プッシュ
2. 再生/停止機能の実装
3. ノート編集機能（ドラッグ&ドロップ）
4. エフェクト機能
5. 音声エクスポート機能

まずは音が鳴ることを確認してください！🎵
